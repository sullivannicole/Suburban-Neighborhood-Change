---
title: "SNC Update - 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Import packages

```{r}
library(tidyverse)
library(openxlsx)
library(foreign)
library(data.table)
library(rgdal)
library(sf)
library(viridis)
library(leaflet)
library(mapview)
library(leafpop)
library(bit64)
library(factoextra)
library(cluster)
library(plotly)
library(extrafont)
#font_import() # Only need to do once
#loadfonts(device = 'win')

Sys.setenv(PATH = paste("C:\\Python27\\ArcGIS10.5\\", Sys.getenv("PATH"), sep=";"))
```



# Cluster on the *absolute difference* between 2000 and 2017 values

```{r}
x00_17 <- read_csv("Data/2000 and 2017 Values for SNC Tracts and Variables.csv")

abs_diff <- x00_17 %>%
  mutate(poc_diff = perc_poc-percentPOC2000*100, # Convert decimal percent to whole points
         age_diff = perc_65up-perSixFive2000*100, # Convert decimal percent to whole points
         hhi_diff = median_hhi-medHHinc2000,
         emv_diff = emv-MedianValue2000,
         rent_diff = rent-rent2000,
         bld_diff = perc_new_bld-builtSince00_2000*100) %>%
  select(TRACT, poc_diff, age_diff, hhi_diff, emv_diff, rent_diff, bld_diff)

write_csv(abs_diff, "Data/Absolute Difference Between 2000 and 2017 for SNC Tracts and Variables.csv")
```

# Generate distribution plots of variables

```{r}
abs_diff_long <- abs_diff %>%
  gather(poc_diff, age_diff, hhi_diff, emv_diff, rent_diff, bld_diff, key = 'Category', value = 'n')

vars <- list('poc_diff', 'bld_diff', 'age_diff', 'hhi_diff', 'rent_diff', 'emv_diff')

# Generate plotly plots of log-transformed v. no transformation of variables
plotly_gen <- function(filter_var) {

  filter_var <- as.character(filter_var)
  
  plot_subject <- ifelse(filter_var == 'poc_diff', 'DIFFERENCE IN % POC',
                         ifelse(filter_var  == 'bld_diff', 'DIFFERENCE IN % NEW BUILDS',
                                ifelse(filter_var  == 'age_diff', 'DIFFERENCE IN % 65+',
                                       ifelse(filter_var  == 'hhi_diff', 'DIFFERENCE IN MEDIAN HHI',
                                              ifelse(filter_var == 'rent_diff', "DIFFERENCE IN MEDIAN GROSS RENT",
                                                     ifelse(filter_var == 'emv_diff', "DIFFERENCE IN MEDIAN PARCEL EMV", 'OTHER VARIABLE'))))))

  plot <- abs_diff_long %>%
  filter(Category == filter_var) %>%
  ggplot(aes(n)) +
  geom_density(alpha = 0.5, fill = '#006666', color = '#006666') +
  labs(title = paste('DISTRIBUTION OF ', plot_subject, ' ACROSS METRO TRACTS'),
       x = plot_subject) +
  theme_minimal() +
  theme(text = element_text(family = "Tw Cen MT", hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 20),
      panel.grid = element_blank(),
      panel.background = element_rect(fill = 'white', color = 'white'))
  
ggplotly(plot)
  
}

purrr::map(vars, plotly_gen)

```

Distributions look pretty good without transformation.  Important because we can't logarithmically transform a negative number and we don't want to lose the sign of the change (+/-).  Without the sign, growth and decline will be treated synonymously.  So we'll go ahead without logarithmic transformation.

# Try clustering without log transformations, same seed (413) and experimenting with different seeds

```{r}
# Create z-scores
set.seed(413)

# Results of uncapped scaling - cannot transform logarithmically because some changes are negative & the direction is important
z_no_cap <- as_tibble(scale(abs_diff[-1]))
summary(z_no_cap)

snc_tr_order <- abs_diff %>%
  select(TRACT)

# Create distance matrix of z-scores
z_matrix <- as.matrix(dist(z_no_cap), labels = TRUE)
fviz_dist(dist(z_matrix)) # Look at distance matrix at a glance

fviz_nbclust(z_matrix, pam, method = "silhouette")

set.seed(413)
options(scipen=999)
pam_abs_diff <- pam(z_matrix, diss = TRUE, k = 3)
plot(pam_abs_diff)

set.seed(92)
options(scipen=999)
pam_abs_diff <- pam(z_matrix, diss = TRUE, k = 3)
plot(pam_abs_diff)

pam_abs_diff$data <- z_matrix

medoids <- as_tibble(pam_abs_diff$medoids) %>% rename(Medoid = value)
clus_width <- as_tibble(pam_abs_diff$silinfo$clus.avg.widths) %>% rename(`Average Width` = value)
pam_abs_diff_df <- bind_cols(medoids, clus_width)
av_width <- as_tibble(pam_abs_diff$silinfo$avg.width) %>%
  mutate(av_width_equals = "Average cluster width = ",
         value = round(value, 2)) %>%
  unite(label, av_width_equals, value, sep = "")

ggplot(pam_abs_diff_df, aes(Medoid, `Average Width`)) +
  geom_bar(stat = "identity", width = 0.2, fill = "#FFCC33") +
  geom_text(aes("361", 0.25), label = av_width$label, family = "Tw Cen MT") +
  labs(title = "Silhouette Width by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
        plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

#ggsave("Results/Cluster Silhouettes.png", width = 10, height = 6)

clusters_abs <- as_tibble(bind_cols(tract = snc_tr_order[,1], cluster = pam_abs_diff$clustering))
tract_z <- as_tibble(bind_cols(tract = snc_tr_order[,1], z_no_cap))
clusters_and_z <- left_join(clusters_abs, tract_z, by = "TRACT")
clusters_and_data <- left_join(clusters_abs, abs_diff, by = "TRACT")

clusters_abs_viz <- clusters_and_z %>%
  rename(`Percent New Builds` = bld_diff,
         `Percent People of Color` = poc_diff,
         `Percent 65+` = age_diff,
         `Median Household Income` = hhi_diff,
         `Median Gross Rent` = rent_diff,
         `Median Estimated Market Value` = emv_diff) %>%
  gather(`Percent New Builds`, `Percent People of Color`, `Percent 65+`, `Median Household Income`, `Median Gross Rent`, `Median Estimated Market Value`, key = "variable", value = "value")

clusters_abs_viz %>%
  mutate(cluster = as.factor(cluster)) %>%
  filter(variable == "Percent New Builds") %>%
ggplot( aes(value, fill = cluster, color = cluster)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  scale_color_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  facet_wrap(~variable) +
  labs(title = "Z-score Distributions by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))
#ggsave("Results/Log Z-score Distributions by Cluster.png", width = 10, height = 6)

clusters_diff_viz <- clusters_and_data %>%
  rename(`Percent New Builds` = bld_diff,
         `Percent People of Color` = poc_diff,
         `Percent 65+` = age_diff,
         `Median Household Income` = hhi_diff,
         `Median Gross Rent` = rent_diff,
         `Median Estimated Market Value` = emv_diff) %>%
  gather(`Percent New Builds`, `Percent People of Color`, `Percent 65+`, `Median Household Income`, `Median Gross Rent`, `Median Estimated Market Value`, key = "variable", value = "value")

clusters_diff_viz %>%
  mutate(cluster = as.factor(cluster)) %>%
  filter(variable == "Percent New Builds") %>%
ggplot( aes(value, fill = cluster, color = cluster)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  scale_color_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  facet_wrap(~variable) +
  labs(title = "Z-score Distributions by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

hist <- clusters_diff_viz %>%
  filter(variable == "Percent People of Color") %>%
ggplot(aes(value)) +
  geom_histogram(alpha = 0.7, fill = "#66CCCC") +
  labs(title = "Histogram of % Change") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

ggplotly(hist)
```

# Cluster on the *percent difference* between 2000 and 2017 values

```{r}
#x00_17 <- read_csv("Data/2000 and 2017 Values for SNC Tracts and Variables.csv")

perc_diff <- x00_17 %>%
  mutate(builtSince00_2000 = ifelse(builtSince00_2000 == 0, 1, builtSince00_2000)) %>%
  mutate(poc_diff = (perc_poc-percentPOC2000*100), # Convert decimal percent to whole points
         age_diff = (perc_65up-perSixFive2000*100), # Convert decimal percent to whole points
         hhi_diff = (median_hhi-medHHinc2000)/medHHinc2000*100,
         emv_diff = (emv-MedianValue2000)/MedianValue2000*100,
         rent_diff = (rent-rent2000)/rent2000*100,
         bld_diff = (perc_new_bld-builtSince00_2000*100)) %>%
  select(TRACT, poc_diff, age_diff, hhi_diff, emv_diff, rent_diff, bld_diff) %>%
  filter(!is.na(emv_diff))

write_csv(perc_diff, "Data/Percent Difference Between 2000 and 2017 for SNC Tracts and Variables.csv")
```

# Percent difference with z-scores

```{r}
# Create z-scores
set.seed(413)

# Results of uncapped scaling - cannot transform logarithmically because some changes are negative & the direction is important
z_no_cap <- as_tibble(scale(perc_diff[-1]))
summary(z_no_cap)

snc_tr_order <- perc_diff %>%
  select(TRACT)

# Create distance matrix of z-scores
z_matrix <- as.matrix(dist(z_no_cap), labels = TRUE)
fviz_dist(dist(z_matrix)) # Look at distance matrix at a glance

fviz_nbclust(z_matrix, pam, method = "silhouette")

set.seed(413)
options(scipen=999)
pam_perc_diff <- pam(z_matrix, diss = TRUE, k = 3)
plot(pam_perc_diff)

set.seed(92)
options(scipen=999)
pam_perc_diff <- pam(z_matrix, diss = TRUE, k = 3)
plot(pam_perc_diff)

pam_perc_diff$data <- z_matrix

medoids <- as_tibble(pam_perc_diff$medoids) %>% rename(Medoid = value)
clus_width <- as_tibble(pam_perc_diff$silinfo$clus.avg.widths) %>% rename(`Average Width` = value)
pam_perc_diff_df <- bind_cols(medoids, clus_width)
av_width <- as_tibble(pam_perc_diff$silinfo$avg.width) %>%
  mutate(av_width_equals = "Average cluster width = ",
         value = round(value, 2)) %>%
  unite(label, av_width_equals, value, sep = "")

ggplot(pam_perc_diff_df, aes(Medoid, `Average Width`)) +
  geom_bar(stat = "identity", width = 0.2, fill = "#FFCC33") +
  geom_text(aes("361", 0.25), label = av_width$label, family = "Tw Cen MT") +
  labs(title = "Silhouette Width by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
        plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

#ggsave("Results/Cluster Silhouettes.png", width = 10, height = 6)

clusters_perc <- as_tibble(bind_cols(tract = snc_tr_order[,1], cluster = pam_perc_diff$clustering))
tract_z <- as_tibble(bind_cols(tract = snc_tr_order[,1], z_no_cap))
clusters_and_z <- left_join(clusters_perc, tract_z, by = "TRACT")
clusters_and_data <- left_join(clusters_perc, perc_diff, by = "TRACT")

clusters_perc_viz <- clusters_and_z %>%
  rename(`Percent New Builds` = bld_diff,
         `Percent People of Color` = poc_diff,
         `Percent 65+` = age_diff,
         `Median Household Income` = hhi_diff,
         `Median Gross Rent` = rent_diff,
         `Median Estimated Market Value` = emv_diff) %>%
  gather(`Percent New Builds`, `Percent People of Color`, `Percent 65+`, `Median Household Income`, `Median Gross Rent`, `Median Estimated Market Value`, key = "variable", value = "value")

clusters_perc_viz %>%
  mutate(cluster = as.factor(cluster)) %>%
ggplot( aes(value, fill = cluster, color = cluster)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  scale_color_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  facet_wrap(~variable) +
  labs(title = "Z-score Distributions by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))
#ggsave("Results/Log Z-score Distributions by Cluster.png", width = 10, height = 6)

clusters_diff_viz <- clusters_and_data %>%
  rename(`Percent New Builds` = bld_diff,
         `Percent People of Color` = poc_diff,
         `Percent 65+` = age_diff,
         `Median Household Income` = hhi_diff,
         `Median Gross Rent` = rent_diff,
         `Median Estimated Market Value` = emv_diff) %>%
  gather(`Percent New Builds`, `Percent People of Color`, `Percent 65+`, `Median Household Income`, `Median Gross Rent`, `Median Estimated Market Value`, key = "variable", value = "value")

clusters_diff_viz %>%
  mutate(cluster = as.factor(cluster)) %>%
  filter(variable == "Percent New Builds") %>%
ggplot( aes(value, fill = cluster, color = cluster)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  scale_color_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  facet_wrap(~variable) +
  labs(title = "Z-score Distributions by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

hist <- clusters_diff_viz %>%
  filter(variable == "Percent People of Color") %>%
ggplot(aes(value)) +
  geom_histogram(alpha = 0.7, fill = "#66CCCC") +
  labs(title = "Histogram of % Change") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

ggplotly(hist)
```

# Percent difference without z-scores (because all in the same units - % - & same scale - -inf to inf)

```{r}
set.seed(413)

perc_diff_clust <- perc_diff %>% select(-TRACT)

snc_tr_order <- perc_diff %>%
  select(TRACT)

# Create distance matrix of percentages
z_matrix <- as.matrix(dist(perc_diff_clust), labels = TRUE)
fviz_dist(dist(z_matrix)) # Look at distance matrix at a glance

fviz_nbclust(z_matrix, pam, method = "silhouette")

set.seed(413)
options(scipen=999)
pam_perc_diff <- pam(z_matrix, diss = TRUE, k = 3)
plot(pam_perc_diff)

# set.seed(92)
# options(scipen=999)
# pam_perc_diff <- pam(z_matrix, diss = TRUE, k = 3)
# plot(pam_perc_diff)

pam_perc_diff$data <- z_matrix

medoids <- as_tibble(pam_perc_diff$medoids) %>% rename(Medoid = value)
clus_width <- as_tibble(pam_perc_diff$silinfo$clus.avg.widths) %>% rename(`Cluster Average Width` = value)
av_width <- as_tibble(pam_perc_diff$silinfo$avg.width)
pam_perc_diff_df <- bind_cols(medoids, clus_width) %>% mutate(`Average Width` = av_width$value)

write_csv(pam_perc_diff_df, "Results/Cluster Silhouettes - Percent Difference, 3-Cluster Solution.csv")

av_width <- as_tibble(pam_perc_diff$silinfo$avg.width) %>%
  mutate(av_width_equals = "Average cluster width = ",
         value = round(value, 2)) %>%
  unite(label, av_width_equals, value, sep = "")

ggplot(pam_perc_diff_df, aes(Medoid, `Average Width`)) +
  geom_bar(stat = "identity", width = 0.2, fill = "#FFCC33") +
  geom_text(aes("223", 0.25), label = av_width$label, family = "Tw Cen MT") +
  labs(title = "Silhouette Width by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
        plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

ggsave("Results/Cluster Silhouettes - Percent Difference, 3-Cluster Solution.png", width = 10, height = 6)

clusters_perc <- as_tibble(bind_cols(tract = snc_tr_order[,1], cluster = pam_perc_diff$clustering)) %>% mutate(cluster_type = "Percent-difference, no z-scores, 3-solution")

write_csv(clusters_perc, "Results/Percent-difference 3-Cluster Solution Clusters.csv")

tract_z <- as_tibble(bind_cols(tract = snc_tr_order[,1], perc_diff_clust))
clusters_and_z <- left_join(clusters_perc, tract_z, by = "TRACT")
clusters_and_data <- left_join(clusters_perc, perc_diff, by = "TRACT")


fviz_cluster(pam_perc_diff, geom = "point", ellipse.type = "norm") +
  scale_fill_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  scale_color_manual(values = c("#FF6666", "#FFCC66", "#99CCCC")) +
  labs(title = "Clusters along Principal Components 1 & 2") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank())

ggsave("Results/Clusters Along PCs 1 & 2 - Percent Difference, 3-Cluster Solution.png", width = 10, height = 6)
```

# See a 2-cluster solution

```{r}
set.seed(413)

perc_diff_clust <- perc_diff %>% select(-TRACT)

snc_tr_order <- perc_diff %>%
  select(TRACT)

# Create distance matrix of z-scores
z_matrix <- as.matrix(dist(perc_diff_clust), labels = TRUE)

fviz_nbclust(z_matrix, pam, method = "silhouette")
ggsave("Results/Percent-Difference Average Silhouette Width by Number of Clusters.png", width = 10, height = 6)

set.seed(413)
options(scipen=999)
pam_perc_diff <- pam(z_matrix, diss = TRUE, k = 2)

pam_perc_diff$data <- z_matrix

medoids <- as_tibble(pam_perc_diff$medoids) %>% rename(Medoid = value)
clus_width <- as_tibble(pam_perc_diff$silinfo$clus.avg.widths) %>% rename(`Cluster Average Width` = value)
av_width <- as_tibble(pam_perc_diff$silinfo$avg.width)
pam_perc_diff_df <- bind_cols(medoids, clus_width) %>% mutate(`Average Width` = av_width$value)


write_csv(pam_perc_diff_df, "Results/Cluster Silhouettes - Percent-Difference, 2-Cluster Solution.csv")

av_width <- as_tibble(pam_perc_diff$silinfo$avg.width) %>%
  mutate(av_width_equals = "Average cluster width = ",
         value = round(value, 2)) %>%
  unite(label, av_width_equals, value, sep = "")

ggplot(pam_perc_diff_df, aes(Medoid, `Average Width`)) +
  geom_bar(stat = "identity", width = 0.2, fill = "#FFCC33") +
  geom_text(aes("223", 0.25), label = av_width$label, family = "Tw Cen MT") +
  labs(title = "Silhouette Width by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
        plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

ggsave("Results/Cluster Silhouettes - Percent-Difference, 2-Cluster Solution.png", width = 10, height = 6)

clusters_perc <- as_tibble(bind_cols(tract = snc_tr_order[,1], cluster = pam_perc_diff$clustering)) %>%
  mutate(cluster_type = "Percent-difference, no z-scores, 2-solution")
tract_z <- as_tibble(bind_cols(tract = snc_tr_order[,1], perc_diff_clust))
clusters_and_z <- left_join(clusters_perc, tract_z, by = "TRACT")
clusters_and_data <- left_join(clusters_perc, perc_diff, by = "TRACT")

write_csv(clusters_perc, "Results/Percent-Difference 2-Cluster Solutions Clusters.csv")

fviz_cluster(pam_perc_diff, geom = "point", ellipse.type = "norm") +
  scale_fill_manual(values = c("#FF6666", "#FFCC66")) +
  scale_color_manual(values = c("#FF6666", "#FFCC66")) +
  labs(title = "Clusters along Principal Components 1 & 2") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank())

ggsave("Results/Clusters Along PCs 1 & 2 - Percent Difference, 2 Cluster Solution.png", width = 10, height = 6)
```

# See a 7-cluster solution

```{r}
set.seed(413)
options(scipen=999)
pam_perc_diff <- pam(z_matrix, diss = TRUE, k = 7)
plot(pam_perc_diff)

pam_perc_diff$data <- z_matrix

medoids <- as_tibble(pam_perc_diff$medoids) %>% rename(Medoid = value)
clus_width <- as_tibble(pam_perc_diff$silinfo$clus.avg.widths) %>% rename(`Cluster Average Width` = value)
av_width <- as_tibble(pam_perc_diff$silinfo$avg.width)
pam_perc_diff_df <- bind_cols(medoids, clus_width) %>% mutate(`Average Width` = av_width$value)

#write_csv(pam_perc_diff_df, "Results/Cluster Silhouettes - Percent-Difference, 7-Cluster Solution.csv")

av_width <- as_tibble(pam_perc_diff$silinfo$avg.width) %>%
  mutate(av_width_equals = "Average cluster width = ",
         value = round(value, 2)) %>%
  unite(label, av_width_equals, value, sep = "")

ggplot(pam_perc_diff_df, aes(Medoid, `Average Width`)) +
  geom_bar(stat = "identity", width = 0.2, fill = "#FFCC33") +
  geom_text(aes("263", 0.3), label = av_width$label, family = "Tw Cen MT") +
  labs(title = "Silhouette Width by Cluster") +
  theme(text = element_text(family = "Tw Cen MT"),
        plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "white"))

#ggsave("Results/Cluster Silhouettes - Percent-Difference, 7-Cluster Solution.png", width = 10, height = 6)

clusters_perc <- as_tibble(bind_cols(tract = snc_tr_order[,1], cluster = pam_perc_diff$clustering)) %>%
  mutate(cluster_type = "Percent-difference, no z-scores, 7-solution")

#write_csv(clusters_perc, "Results/Percent-Difference 7-Cluster Solution Clusters.csv")

fviz_cluster(pam_perc_diff, geom = "point", ellipse.type = "norm") +
  labs(title = "Clusters along Principal Components 1 & 2") +
  theme(text = element_text(family = "Tw Cen MT"),
    plot.title = element_text(hjust = 0.5, size = 30),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        axis.ticks = element_blank())

#ggsave("Results/Clusters Along PCs 1 & 2 - Percent Difference, 7-Cluster Solution.png", width = 10, height = 6)
library(stats)

pca <- stats::prcomp(pam_perc_diff$data, scale = FALSE, center = FALSE)
axes <- c(1,2)
ind <- facto_summarize(pca, element = "ind", result = "coord", axes = axes)
eig <- get_eigenvalue(pca)[axes, 2]

plot.data <- cbind.data.frame(ind, cluster = pam_perc_diff$cluster)
write_csv(plot.data, "PCA on 7 clusters.csv")

dims <- plot.data %>% select(Dim.1, Dim.2)
dims_scaled <- scale(dims)

dims_scaled_df <- as_tibble(dims_scaled)
cluster_df <- as_tibble(pam_perc_diff$clustering) %>% rename(cluster = value)
dims_cl <- bind_cols(dims_scaled_df, cluster_df)

dims_cl %>%
ggplot(aes(Dim.1*-1, Dim.2, color = cluster)) +
  geom_point() +
  geom_jitter()


```


